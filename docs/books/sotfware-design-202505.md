# Software Design 202505

## オブザーバビリティ

### 基本

オブザーバビリティはモニタリングの進化系。

テレメトリーデータとはシステムの状態を示すデータの総称で、以下の4つからなる。

- メトリクス
  - 時系列で「どのリソースがどれだけ」使われたかを計測する
- ログ
  - 個々のイベントを詳細に記録する
- トレース
  - リクエスト経路を可視化する
- プロファイル
  - どの関数でどれだけ CPU 時間やメモリを消費しているかを継続的に収集する

モニタリングではこれらの情報間の紐付けや連携は手動だったが、
オブザーバビリティでは自動で行われる。

オブザーバビリティの実現には、計装/収集/蓄積/活用の4ステップが必要である。

### ツールの選択

オブザーバビリティツールは以下のようなものがある。

商用だと、計装から活用までの必要な道具がすべて用意されていることが多い。

- New Relic
- Datadog
- Honeycomb
- Dynatrace
- AWS - CloudWatch
- Google Cloud - Cloud Operations

OSSだと以下のようなものがある。
ただしデータの蓄積と活用は、Grafanaなど単一のシステムで管理しないと
オブザーバビリティが実現できないので注意。

- メトリクス
  - Prometheus
  - Grafana Mimir (Prometheus互換)
  - VictoriaMetrics
- ログの検索・保持
  - Elasticsearch
  - Grafana Loki
  - Victoria Logs
- ログの収集・変換・転送
  - Fluentd
  - Logstash
- トレース
  - Tempo
  - Jaeger
  - Zipkin
- プロファイル
  - Grafana Pyroscope

最近はOpenTelemetryという選択もある。
OpenTelemetry Protocol (OTLP) をやりとりするSDKやツールの総称。
これが常に正解というわけではなく、技術制約、コスト、運用などさまざまな観点から検討が必要。

### メトリクス

メトリクスは定量的・時系列なデータである。
いつ問題が起き始めたのか、それがどう変化したのかをみることができる。
種類は以下の4つである。

- カウンター:
  - 増加し続ける
  - e.g. エラー数など
- ゲージ
  - 現在の状態を表す絶対値
  - e.g. CPU使用率など
- ヒストグラム
  - あらかじめ定義したバケット（範囲）ごとに数を記録する
  - e.g. リクエスト処理時間とその数など

ラベル(e.g. Status code, HTTP Methodなど)をつけることでさらに詳細な分析ができる。
ただしカーディナリティに注意。これはラベルが取りうる値の種類の数のこと。
高いとコストが爆発したり分析が重くなったりする。
本当に必要なものに限って使用すると良い。

### ログ

アプリケーションログ、システムログ、監査ログ、パフォーマンスログ、アクセスログなど色々ある。

- 暗号めいた文章ではなく、人間に優しい文章で出す
- 分析に役に立ちそうな具体的な情報を含める
- トレースIDやスパンIDを含める
- センシティブな情報を取り除く
- 過剰な量のログを出さない
- JSONやlogfmt形式など、構造化ログで出す
- 1つのイベントのログは1つのログで出す（複数あると前後入れ替わるよ）
- ログレベルを適切に設定する

##＃トレース

実行経路を追跡するためのデータ。
複数のサービスを横断して実行される処理を可視化するために活用する。

**スパン**は作業や操作の単位のこと。
任意の単位で分割できる。親子関係を持てる。

**トレース**は1つのリクエストの実行経路全体を指す。
複数のスパンから構成される。

**コンテキスト伝播**は、レースやスパンの識別子等をサービス間で受け渡す仕組みのこと。
HTTPヘッダで受け渡される。

全てのトレースデータを保存すると膨大になるのでサンプリングを行う。
正常リクエストは確率で間引き、エラーリクエストは全て保持するなど。

メトリクスやログにトレースIDやスパンIDを含めることで、様々な切り口での調査が可能になる。

### Grafanaの基礎

システム監視やデータ分析にためのプラットフォーム。
メトリクス、ログ、トレースなど多様なテレメトリーデータに対応。
OSSで提供され、基本機能は無料。
様々なデータソースに対応している。

PromQLやLogQLなど、サービスごとに独自のクエリ言語が存在する。
