# Software Design 202510

## ORM

ORMを使うにはSQLの知識も必須である。

- メリット
  - 直接SQLを書くのと比べて楽で簡潔(直接書くと単純なJOINですら扱いが面倒)
  - DBスキーマ管理を効率化できる
- デメリット
  - 非効率なSQL(N+1など)が知らずに発生しがち
  - DB固有の複雑な機能を使いたいときの足かせになることもある

### Prisma

Prismaの特徴

- クラスではなく、純粋なオブジェクトによりデータを表現する
  - これはシステム成長に伴いクラスのメソッドが肥大化する「ファットモデル」問題を避けるため。
- 抽象的なAPIによりSQLに詳しくなくても簡単に使えるようにする設計思想
- 型安全性
- DSLによる宣言的なDBスキーマ管理

デメリット

`undefined`を誤って渡すと条件が指定されていないと解釈される。これで事故る例が多々あり。
これを防ぐには、`strictUndefinedChecks`機能を有効にする。
ただしこれはランタイムのチェックであり、型レベルでの検出はできないので、
あわせてTSの`exactOptionalPropertyTypes`を有効にすることが推奨される。
もしくはPostgresの Row Level Security 機能などを利用する。

TSの構造的部分型の特性により、意図しないカラムが露出する事故も起きがち。
対策としては、取得時にselectを使用する、レスポンスオブジェクトを作成してマッピングする、
zodによる切り落としを行う、等がある。

DSLが表現の足かせになる。たとえばRLSはDSLでは表現できないので生SQLを書く必要がある。

独自の型やクラスをカラムにマッピングできない。

発行されるSQLが不透明。例えばincludeしたときのSQLはIN句なのでパフォーマンス問題が起きがち。
`relationJoins`というPreview Featureもあるが、これを使ってもJOINじゃなくて
サブクエリが使われるため、クエリはさらに複雑化する。

### Drizzle

Drizzleの特徴

- 大規模アプリや複雑なデータ操作に最適
  - 生成されるSQLが予見可能
  - TSのブランド型をカラムにマッピングできて便利。値の検証も可能。
  - 概して、Prismaの苦手な領域を特異とする
- コードファースト(TSでスキーマを定義する)
- SQLライクなAPIも、抽象化されたAPIも、両方使える
- 事前のコード生成が不要
- まだv0系

Tips

DBコネクションプールの作成（Controller層）とその利用場所（Repository層）は、コード上での距離が遠い。
普通に考えると引数によるバケツリレーが必要になるが、これは可読性や保守性を著しく低下させる。
これを防ぐためには、Node.jsの`asyncLocalStorage`と、Webフレームワークのミドルウェアを組み合わせるとよい。
DB接続プールやユーザー情報といったリクエスト固有の情報を、
呼び出しスタックの深い箇所からでもシンプルに行うことが可能になる。

## つまみぐい関数型プログラミング

関数型専用の言語でなくても、以下のようなことに気をつければ、関数型プログラミングはできる。

- 副作用を意識する
- 可能な限り純粋関数に処理を切り出す(部分的でも全然OK)
- データをイミュータブルに扱う
- 小さな関数を合成して処理を組み立てていく

純粋関数を作るときのコツは、副作用のある操作を関数の外に追い出すこと。
そうすれば、テスト時に外から依存をInjectしたうえで、純粋関数としてテストが可能になる
このテクニックはどの言語でも使える普遍的なものだ。
