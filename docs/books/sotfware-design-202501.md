# Software Design 202501

## 認証技術の最前線

### ユーザー認証とは

ユーザー認証は以下の要素で構成される。

- 当人認証
  - 識別
  - 検証
- 身元確認

当人認証とは、登録済みのユーザーが本人であることを確認することである。これには、識別と検証の二つのプロセスがある。

識別は、ユーザーを特定することである。例えば、ユーザーが入力したメールアドレス等に基づいて、ユーザーを特定する。
検証は、本当にその人なのかを確認する作業のこと。例えば、パスワードを入力してもらい、それが登録済みの値を等しいかを確認する。

身元確認は、ユーザーの属性情報が正しいかの確認である。例えば、住所や電話番号などの情報が正しいかどうかを公的個人認証で確認するなど。

### 多要素認証の課題

- 知識情報 / Something you know
- 所持情報 / Something you have
- 生体情報 / Something you are

多要素認証と言ったときには、パスワードともう一つ別の要素を認証に使う方法を指すことが多い。
パスワードを使うと必然的にフィッシングに対する耐性がなくなる。
パスワードマネージャーを使えばフィッシングへの耐性を得られるが、普及は中途半端である。

例えば、中継型フィッシング攻撃/Man-in-the-Middle という攻撃手法がある。
これは正規サイトと同じ見た目の偽サイトを用意してユーザーに ID/Pass/OTP などを入力させ、その情報をリアルタイムで正規サイトに中継し、ログイン成功後に生成されるセッション情報を盗む攻撃のこと。
ただのフィッシングと異なり、多要素認証すら突破されてしまう攻撃手法である。

### パスワードレス

所持情報だけを単体で利用する方法（1 要素認証）。

- マジックリンク
  - メール本文に URL が書いてあるので、フィッシングに強い
  - メールを受信できる環境が複数存在しうるので、所持情報の強度が弱い
- SMS 認証
  - SIM カードという所持情報を利用するため所持情報の強度が強い
  - フィッシングに弱い

### FIDO 認証

FIDO 認証はパスワードレス認証方式の一つ。サービス、デバイス、ブラウザという登場人物がいる。

- サービス
  - FIDO 認証を利用する Web サービスのこと
  - 正式名称は Relying Party (RP)
- デバイス
  - 認証に必要な情報を格納した、認証に利用する、ユーザーが所持するデバイス。
  - 正式名称は Authenticator
- ブラウザ
  - サービスから FIDO 認証を要求され、デバイスとやり取りをする仲介役。
  - 正式名称は Client

FIDO 認証は公開鍵暗号方式のデジタル署名の仕組みをユーザー認証に利用している。

- 初回
  - デバイスに秘密鍵(FIDO クレデンシャルという)を、サービスに公開鍵を登録する
  - 処理の流れはログイン時とほぼ同じ
  - 鍵はサービスごとに生成される
- ログイン時
  - サービスが、チャレンジ（ランダムに生成された値）やドメインの情報をブラウザに送る
  - ブラウザはオリジンを検証したのちデバイスに認証を要求する
  - デバイスでローカル認証を行う
  - デバイスは秘密鍵を用いてチャレンジを含むデジタル署名を生成して返答する
  - サービスは公開鍵を用いてデジタル署名を検証する

秘密鍵に加え、知識情報 or 生体情報を使うため、二要素認証である。

パスワードに比べたときのメリットは以下の通り。

- 覚えなくていい
- フィッシングに強い
- 秘密鍵はネットワークを流れない
- サーバー側の公開鍵は流出しても無害
- 秘密鍵が流出しても影響はそのサービスに限られる

### パスキー認証の登場

FIDO 認証ではデバイスを無くしたときのダメージが大きすぎる。
この問題を解決するのがパスキー認証である。

FIDO 認証では秘密鍵をデバイス内に保存するが、パスキー認証では秘密鍵をパスワードマネージャーに保存する。

### 細かい話

- アカウントリカバリーを考えると、複数のパスワードマネージャーに登録してもらうのがいまんとこ良さそう
- パスキーはデバイスだけでなくセキュリティキーにも保存できる
- パスキー作成時にしかるべきオプション指定をすると、ログイン画面でいきなりアカウント選択 UI(Autofill UI)を出すことが可能
- 複数ドメインで共通のパスキーを利用させたいときは、`.well-known/webauthn`に JSON を配置することで可能になる
